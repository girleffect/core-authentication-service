
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>authentication_service.views &#8212; authentication_service  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for authentication_service.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">defender.decorators</span> <span class="k">import</span> <span class="n">watch_login</span>
<span class="kn">from</span> <span class="nn">defender.utils</span> <span class="k">import</span> <span class="n">REDIS_SERVER</span><span class="p">,</span> <span class="n">get_username_attempt_cache_key</span><span class="p">,</span> \
    <span class="n">get_username_blocked_cache_key</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="k">import</span> <span class="n">login</span><span class="p">,</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">update_session_auth_hash</span><span class="p">,</span> \
    <span class="n">hashers</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="k">import</span> <span class="n">AuthenticationForm</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.tokens</span> <span class="k">import</span> <span class="n">default_token_generator</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.views</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">PasswordResetView</span><span class="p">,</span>
    <span class="n">PasswordResetConfirmView</span><span class="p">,</span>
    <span class="n">PasswordChangeView</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="k">import</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">reverse_lazy</span>
<span class="kn">from</span> <span class="nn">django.forms.utils</span> <span class="k">import</span> <span class="n">ErrorList</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="k">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="k">import</span> <span class="n">force_bytes</span>
<span class="kn">from</span> <span class="nn">django.utils.http</span> <span class="k">import</span> <span class="n">urlsafe_base64_encode</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="k">import</span> <span class="n">View</span><span class="p">,</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="k">import</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">,</span> <span class="n">FormView</span>

<span class="kn">from</span> <span class="nn">two_factor.forms</span> <span class="k">import</span> <span class="n">AuthenticationTokenForm</span>
<span class="kn">from</span> <span class="nn">two_factor.forms</span> <span class="k">import</span> <span class="n">BackupTokenForm</span>
<span class="kn">from</span> <span class="nn">two_factor.utils</span> <span class="k">import</span> <span class="n">default_device</span>
<span class="kn">from</span> <span class="nn">two_factor.views</span> <span class="k">import</span> <span class="n">core</span>

<span class="kn">from</span> <span class="nn">authentication_service</span> <span class="k">import</span> <span class="n">forms</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">constants</span>


<span class="n">REDIRECT_COOKIE_KEY</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">COOKIES</span><span class="p">[</span><span class="s2">&quot;redirect_cookie&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="LanguageMixin"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LanguageMixin">[docs]</a><span class="k">class</span> <span class="nc">LanguageMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This mixin sets an instance variable called self.language, value is</span>
<span class="sd">    passed in via url or determined by django language middleware</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LanguageMixin.dispatch"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LanguageMixin.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LanguageMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RedirectMixin"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RedirectMixin">[docs]</a><span class="k">class</span> <span class="nc">RedirectMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This mixin gets the redirect URL parameter from the request URL. This URL</span>
<span class="sd">    is used as the success_url attribute. If no redirect_url is set, it will</span>
<span class="sd">    default to the Login URL.</span>

<span class="sd">    For registration, this mixin also checks the security level of the request.</span>
<span class="sd">    If the security level is high, the success URL will redirect to 2FA setup.</span>

<span class="sd">    TODO: Security should be moved out.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RedirectMixin.dispatch"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RedirectMixin.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">REDIRECT_COOKIE_KEY</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RedirectMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RedirectMixin.get_success_url"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RedirectMixin.get_success_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;security&quot;</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;show2fa&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;two_factor_auth:setup&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span>
        <span class="k">return</span> <span class="n">url</span></div></div>


<div class="viewcode-block" id="LanguageRedirectMixin"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LanguageRedirectMixin">[docs]</a><span class="k">class</span> <span class="nc">LanguageRedirectMixin</span><span class="p">(</span><span class="n">LanguageMixin</span><span class="p">,</span> <span class="n">RedirectMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combined class for the frequently used Language and Redirect mixins.</span>
<span class="sd">    Language can safely be set on views that make no use of it.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="LockoutView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LockoutView">[docs]</a><span class="k">class</span> <span class="nc">LockoutView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view used by Defender to inform the user that they have exceeded the</span>
<span class="sd">    threshold for allowed login failures or password reset attempts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/lockout.html&quot;</span>

<div class="viewcode-block" id="LockoutView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LockoutView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">LockoutView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;referrer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_REFERER&quot;</span><span class="p">)</span>
        <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;failure_limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFENDER_LOGIN_FAILURE_LIMIT</span>
        <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;cooloff_time_minutes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DEFENDER_COOLOFF_TIME</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ct</span></div></div>


<div class="viewcode-block" id="LoginView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.LoginView">[docs]</a><span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">LoginView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This view simply extends the LoginView from two_factor.views.core. We</span>
<span class="sd">    only override the template and the done step, which we use to login</span>
<span class="sd">    superusers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/login/login.html&quot;</span>

    <span class="n">form_list</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="n">AuthenticationForm</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="n">AuthenticationTokenForm</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;backup&#39;</span><span class="p">,</span> <span class="n">BackupTokenForm</span><span class="p">),</span>
    <span class="p">)</span></div>


<span class="c1"># Protect the login view using Defender. Defender provides a method decorator</span>
<span class="c1"># which we have to tweak to apply to the dispatch method of a view.</span>
<span class="c1"># This is based on their own implementation of their middleware class:</span>
<span class="c1"># https://github.com/kencochrane/django-defender/blob/master/defender/middleware.py#L24-L27</span>
<span class="n">defender_decorator</span> <span class="o">=</span> <span class="n">watch_login</span><span class="p">()</span>
<span class="n">watch_login_method</span> <span class="o">=</span> <span class="n">method_decorator</span><span class="p">(</span><span class="n">defender_decorator</span><span class="p">)</span>
<span class="n">LoginView</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">watch_login_method</span><span class="p">(</span><span class="n">LoginView</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
<span class="c1"># TODO: Do something similar to the password reset view when it is implemented.</span>


<div class="viewcode-block" id="RegistrationView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView">[docs]</a><span class="k">class</span> <span class="nc">RegistrationView</span><span class="p">(</span><span class="n">LanguageRedirectMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/registration/registration.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">RegistrationForm</span>
    <span class="n">security</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RegistrationView.dispatch"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Grab language off of querystring first. Otherwise default to django</span>
        <span class="c1"># middleware set one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_formset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">formset</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">SecurityQuestionFormSet</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">formset</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">SecurityQuestionFormSet</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">formset</span>

<div class="viewcode-block" id="RegistrationView.get_form_kwargs"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView.get_form_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;security&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;security&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;requires&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">required</span>

        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;hide&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;hidden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden</span>

        <span class="k">return</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="RegistrationView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Either a new formset instance or an existing one is passed to the</span>
        <span class="c1"># formset class.</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question_formset&quot;</span><span class="p">):</span>
            <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="k">return</span> <span class="n">ct</span></div>

<div class="viewcode-block" id="RegistrationView.form_invalid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView.form_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">form_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">question_formset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="RegistrationView.form_valid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.RegistrationView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">formset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">formset</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span>
                <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">question_formset</span><span class="o">=</span><span class="n">formset</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Let the user model save.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

        <span class="c1"># When we need to show the option to enable 2FA the newly created</span>
        <span class="c1"># user must be logged in.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;show2fa&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="n">new_user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
                                    <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password1&#39;</span><span class="p">])</span>
            <span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">new_user</span><span class="p">)</span>

        <span class="c1"># Do some work and assign questions to the user.</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">formset</span><span class="o">.</span><span class="n">forms</span><span class="p">:</span>
            <span class="c1"># Trust that form did its work. In the event that not all questions</span>
            <span class="c1"># were answered, save what can be saved.</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>

                <span class="c1"># All fields on model are required, as such it requires the</span>
                <span class="c1"># full set of data.</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;language_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span>
                <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserSecurityQuestion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
                <span class="n">REDIRECT_COOKIE_KEY</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="CookieRedirectView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.CookieRedirectView">[docs]</a><span class="k">class</span> <span class="nc">CookieRedirectView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple view that redirects in the event the client passes a cookie</span>
<span class="sd">    containing the correct key. In the event a cookie is not present, redirect</span>
<span class="sd">    to the django default login url.</span>

<span class="sd">    User is explicitly logged out to clear the user session. In anticipation</span>
<span class="sd">    that the referrer will prompt them to login again so as to obtain the oidc</span>
<span class="sd">    tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CookieRedirectView.dispatch"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.CookieRedirectView.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># No need for super, this view should at this stage not need any of its</span>
        <span class="c1"># http method functions.</span>
        <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">REDIRECT_COOKIE_KEY</span><span class="p">)</span>

        <span class="c1"># Default fallback if cookie was deleted or no url was set.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">REDIRECT_COOKIE_KEY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="EditProfileView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.EditProfileView">[docs]</a><span class="k">class</span> <span class="nc">EditProfileView</span><span class="p">(</span><span class="n">LanguageRedirectMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/profile/edit_profile.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EditProfileForm</span>

<div class="viewcode-block" id="EditProfileView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.EditProfileView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">EditProfileView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Check if user has 2fa enabled</span>
        <span class="k">if</span> <span class="n">default_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;2fa_enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="EditProfileView.get_object"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.EditProfileView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span></div></div>


<div class="viewcode-block" id="UpdatePasswordView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdatePasswordView">[docs]</a><span class="k">class</span> <span class="nc">UpdatePasswordView</span><span class="p">(</span><span class="n">LanguageRedirectMixin</span><span class="p">,</span> <span class="n">PasswordChangeView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/profile/update_password.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">PasswordChangeForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;edit_profile&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="UpdatePasswordView.form_valid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdatePasswordView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully updated password.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UpdatePasswordView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateSecurityQuestionsView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdateSecurityQuestionsView">[docs]</a><span class="k">class</span> <span class="nc">UpdateSecurityQuestionsView</span><span class="p">(</span><span class="n">LanguageRedirectMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> \
        <span class="s2">&quot;authentication_service/profile/update_security_questions.html&quot;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;edit_profile&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">get_formset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserSecurityQuestion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span>
        <span class="n">formset</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">UpdateSecurityQuestionFormSet</span><span class="p">(</span>
            <span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">formset</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">UpdateSecurityQuestionFormSet</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span>
                <span class="n">language</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
                <span class="n">queryset</span><span class="o">=</span><span class="n">queryset</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">formset</span>

<div class="viewcode-block" id="UpdateSecurityQuestionsView.render"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdateSecurityQuestionsView.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">formset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">(),</span>
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="n">formset</span><span class="o">=</span><span class="n">formset</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="UpdateSecurityQuestionsView.get"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdateSecurityQuestionsView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">formset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">formset</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateSecurityQuestionsView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdateSecurityQuestionsView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;question_formset&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question_formset&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="p">}</span>

        <span class="c1"># Either a new formset instance or an existing one is passed to the</span>
        <span class="c1"># formset class.</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question_formset&quot;</span><span class="p">):</span>
            <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;question_formset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="k">return</span> <span class="n">ct</span></div>

<div class="viewcode-block" id="UpdateSecurityQuestionsView.post"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.UpdateSecurityQuestionsView.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">formset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formset</span>
        <span class="k">if</span> <span class="n">formset</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">formset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">formset</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DeleteAccountView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.DeleteAccountView">[docs]</a><span class="k">class</span> <span class="nc">DeleteAccountView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/profile/delete_account.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">DeleteAccountForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;edit_profile&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DeleteAccountView.dispatch"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.DeleteAccountView.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">msisdn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You require either an email or msisdn &quot;</span>
                <span class="s2">&quot;to request an account deletion&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DeleteAccountView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeleteAccountView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.DeleteAccountView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DeleteAccountView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;confirm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confirm&quot;</span><span class="p">):</span>
            <span class="n">ct</span><span class="p">[</span><span class="s2">&quot;confirm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ct</span></div>

<div class="viewcode-block" id="DeleteAccountView.form_valid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.DeleteAccountView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;confirmed_deletion&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span>
                <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;context_key&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">send_mail</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;context&quot;</span><span class="p">:{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]},</span>
                    <span class="s2">&quot;mail_type&quot;</span><span class="p">:</span> <span class="s2">&quot;delete_account&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;objects_to_fetch&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">user</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully requested account deletion.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DeleteAccountView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ResetPasswordView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordView">[docs]</a><span class="k">class</span> <span class="nc">ResetPasswordView</span><span class="p">(</span><span class="n">PasswordResetView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This view allows the user to enter either their username or their email</span>
<span class="sd">    address in order for us to identify them. After we have identified the user</span>
<span class="sd">    we check what method to user to help them reset their password. If the user</span>
<span class="sd">    has an email address, we send them a reset link. If they have security</span>
<span class="sd">    questions, we take them to the ResetPasswordSecurityQuestionsView to enter</span>
<span class="sd">    their answers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;authentication_service/reset_password/reset_password.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">ResetPasswordForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s2">&quot;password_reset_done&quot;</span><span class="p">)</span>
    <span class="c1">#email_template_name = &quot;reset_password/password_reset_email.html&quot;</span>

<div class="viewcode-block" id="ResetPasswordView.looks_like_email"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordView.looks_like_email">[docs]</a>    <span class="k">def</span> <span class="nf">looks_like_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">identifier</span></div>

<div class="viewcode-block" id="ResetPasswordView.form_valid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>

        <span class="c1"># Identify user</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">looks_like_email</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CoreUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CoreUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># Check reset method</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="c1"># Store the id of the user that we found in our search</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;lookup_user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="c1"># Check if user has email or security questions.</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_security_questions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;reset_password_security_questions&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># This should never be the case.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;User </span><span class="si">%s</span><span class="s2"> cannot reset their password.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;password_reset_done&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ResetPasswordView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ResetPasswordSecurityQuestionsView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordSecurityQuestionsView">[docs]</a><span class="k">class</span> <span class="nc">ResetPasswordSecurityQuestionsView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> \
        <span class="s2">&quot;authentication_service/reset_password/security_questions.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">ResetPasswordSecurityQuestionsForm</span>

<div class="viewcode-block" id="ResetPasswordSecurityQuestionsView.get_form_kwargs"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordSecurityQuestionsView.get_form_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span>
            <span class="n">ResetPasswordSecurityQuestionsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;questions&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">models</span><span class="o">.</span><span class="n">UserSecurityQuestion</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">user__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;lookup_user_id&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="ResetPasswordSecurityQuestionsView.get_context_data"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordSecurityQuestionsView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ResetPasswordSecurityQuestionsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CoreUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;lookup_user_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">username</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ResetPasswordSecurityQuestionsView.form_valid"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordSecurityQuestionsView.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">questions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hashers</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;question_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="n">question</span><span class="o">.</span><span class="n">answer</span>
            <span class="p">):</span>
                <span class="n">form</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;One or more answers are incorrect&quot;</span><span class="p">),</span>
                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;incorrect&quot;</span>
                <span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_invalid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ResetPasswordSecurityQuestionsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResetPasswordSecurityQuestionsView.get_success_url"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.ResetPasswordSecurityQuestionsView.get_success_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CoreUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;lookup_user_id&quot;</span><span class="p">])</span>
        <span class="n">uidb64</span> <span class="o">=</span> <span class="n">urlsafe_base64_encode</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">default_token_generator</span><span class="o">.</span><span class="n">make_token</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;password_reset_confirm&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;uidb64&quot;</span><span class="p">:</span> <span class="n">uidb64</span><span class="p">,</span> <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
        <span class="p">)</span></div></div>


<span class="n">defender_decorator</span> <span class="o">=</span> <span class="n">watch_login</span><span class="p">()</span>
<span class="n">watch_login_method</span> <span class="o">=</span> <span class="n">method_decorator</span><span class="p">(</span><span class="n">defender_decorator</span><span class="p">)</span>
<span class="n">ResetPasswordSecurityQuestionsView</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">watch_login_method</span><span class="p">(</span>
    <span class="n">ResetPasswordSecurityQuestionsView</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>


<div class="viewcode-block" id="PasswordResetConfirmView"><a class="viewcode-back" href="../../authentication_service.views.html#authentication_service.views.PasswordResetConfirmView">[docs]</a><span class="k">class</span> <span class="nc">PasswordResetConfirmView</span><span class="p">(</span><span class="n">PasswordResetConfirmView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">SetPasswordForm</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>